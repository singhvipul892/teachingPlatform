services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-teacher_videos}
      POSTGRES_USER: ${POSTGRES_USER:-teacher}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - teacher_db:/var/lib/postgresql/data
      - ./backend/docker/init:/docker-entrypoint-initdb.d

  api:
    image: teachingplatform-api
    build:
      context: ./backend
      dockerfile: Dockerfile
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/${POSTGRES_DB:-teacher_videos}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-teacher}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      APP_STORAGE_S3_REGION: ${APP_STORAGE_S3_REGION:-ap-south-1}
      APP_STORAGE_S3_BUCKET: ${APP_STORAGE_S3_BUCKET}
      APP_STORAGE_S3_PRESIGN_EXPIRY_MINUTES: ${APP_STORAGE_S3_PRESIGN_EXPIRY_MINUTES:-10}
      JWT_SECRET: ${JWT_SECRET}
      AWS_EC2_METADATA_SERVICE_ENDPOINT: http://host.docker.internal:1338
    depends_on:
      - db

  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Use nginx.no-ssl.conf when certs are not available (bootstrap). Set NGINX_CONF=nginx.no-ssl.conf in .env.
      - ./nginx/${NGINX_CONF:-nginx.conf}:/etc/nginx/conf.d/default.conf:ro
      - letsencrypt_certs:/etc/letsencrypt:ro
      - certbot_webroot:/var/www/certbot:ro
    depends_on:
      - api

  certbot:
    image: certbot/certbot
    volumes:
      - letsencrypt_certs:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
    # Run one-off: docker compose -f docker-compose.prod.yml run --rm certbot certonly --webroot -w /var/www/certbot -d teacherplatform.duckdns.org --email YOUR_EMAIL --agree-tos --non-interactive

  metadata-proxy:
    build:
      context: ./docker/metadata-proxy
      dockerfile: Dockerfile
    network_mode: host

  pgadmin:
    image: dpage/pgadmin4:8.12
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@local.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
    ports:
      - "5050:80"
    depends_on:
      - db

volumes:
  teacher_db:
  letsencrypt_certs:
  certbot_webroot:
